# FUSE 1.0.0 M1 Frozen-Surface Test Slices

Status: Active (enumerated 2026-02-28)  
Parent milestone: `M1` in `./1.0.0_PLAN.md`  
Frozen-surface source: `../spec/1.0.0_STABILITY_CONTRACT.md` (`FS-1.*`, `FS-3.*`)

This document turns remaining M1 gaps into concrete, reviewable PR slices.

## Slice Progress

- [x] `M1-PR1` parser negative diagnostics lock (implemented locally; `parser_fixtures` gate pass on 2026-02-28)
- [ ] `M1-PR2` `?!` static semantics closure
- [ ] `M1-PR3` boundary default/validation timing matrix
- [ ] `M1-PR4` HTTP status + error JSON matrix parity
- [ ] `M1-PR5` dependency source-rule diagnostics matrix
- [ ] `M1-PR6` lockfile invariant + refresh-fingerprint matrix

## Remaining Gaps Snapshot

| Clause | Current coverage | Remaining gap to close |
|---|---|---|
| `FS-1.1` grammar/parsing/static semantics freeze | Positive parser fixtures + selected AST-shape checks in `crates/fusec/tests/parser_fixtures.rs` | Missing parser-level negative diagnostics lock for known parser error branches (HTML block misuse, interpolation parse errors, mixed pattern forms). |
| `FS-1.2` boundary validation/default timing | Config precedence + validation tests exist (mostly AST), plus selected parity tests | Missing cross-backend matrix for default-vs-null semantics and validation timing at struct/HTTP/config boundaries. |
| `FS-1.3` JSON encode/decode behavior | `result_decode_runtime`, `golden_outputs`, `aot_parity_lock` cover core tagged `Result`/JSON paths | Missing strict malformed-payload matrix (missing `data`, unknown fields, wrong payload shapes) asserted consistently across backends. |
| `FS-1.6` HTTP status mapping | 200/400/404 paths covered in existing tests | Missing full status mapping matrix (401/403/409, `std.Error.status` override, fallback 500/internal_error) with parity assertions. |
| `FS-1.7` `Option`/`Result` + `?!` behavior | Core sema checks for explicit error domain + selected `?!` diagnostics already present | Missing explicit sema lock for remaining `?!` invariants (`?!` outside function, `?!` in non-fallible function, catch-all `Error` domain prohibition path). |
| `FS-3.1` dependency source/git-selector rules | Tests currently assert only `FUSE_DEP_CONFLICTING_SPECS`, `FUSE_DEP_GIT_REF_CONFLICT`, `FUSE_DEP_INVALID_SOURCE` | Missing diagnostics matrix for remaining source constraints (`SOURCE_REQUIRED`, `GIT_PATH_CONFLICT`, `GIT_REQUIRED_FOR_REFS`, `PATH_EMPTY`, `SUBDIR_EMPTY`, `PATH_FIELDS_INVALID`, `PATH_NOT_FOUND`, `SUBDIR_NOT_FOUND`). |
| `FS-3.2` transitive resolver conflict policy | Conflict rejection with origin paths is covered | Add one normalization/idempotence case to prove no false conflict when specs are semantically identical but syntactically varied. |
| `FS-3.3` lockfile format stability | Unsupported version + stale path checks exist | Missing explicit tests for remaining lock entry invariants (`MISSING_PATH`, `MISSING_REV`, `MISSING_GIT`, `SUBDIR_NOT_FOUND`, `UNKNOWN_SOURCE`, parse failure path). |
| `FS-3.4` lock refresh semantics | Stable lock under unchanged deps and cache invalidation when dependency source changes are covered | Missing targeted fingerprint refresh test: lock remains stable when non-spec manifest edits occur, and refreshes only when requested spec fingerprint changes. |

## Concrete PR Slices

### Slice `M1-PR1`: Parser negative diagnostics lock (`FS-1.1`)

Scope:
- add parser-negative fixtures in `crates/fusec/tests/parser_fixtures.rs`

Tests to add:
1. `parser_html_block_rejects_non_call_target`
2. `parser_html_block_rejects_non_expression_child_stmt`
3. `parser_html_block_rejects_multiple_explicit_attrs_args`
4. `parser_interpolation_rejects_empty_expression`
5. `parser_interpolation_rejects_unexpected_tokens`
6. `parser_match_pattern_rejects_mixed_positional_named`

Gate:
- `scripts/cargo_env.sh cargo test -p fusec --test parser_fixtures`

### Slice `M1-PR2`: `?!` static semantics closure (`FS-1.7`)

Scope:
- extend `crates/fusec/tests/sema_golden.rs`

Tests to add:
1. `rejects_bang_chain_outside_function_scope`
2. `rejects_bang_chain_in_non_fallible_function`
3. `rejects_catch_all_error_domain_in_boundary_signature`
4. `rejects_bang_chain_with_non_domain_err_rebinding_in_nested_scope`

Gate:
- `scripts/cargo_env.sh cargo test -p fusec --test sema_golden`

### Slice `M1-PR3`: Boundary default/validation timing matrix (`FS-1.2`)

Scope:
- extend `crates/fusec/tests/config_runtime.rs`
- extend `crates/fusec/tests/golden_outputs.rs` (or add dedicated boundary runtime test file)

Tests to add:
1. `config_defaults_apply_before_validation_all_backends`
2. `config_explicit_null_preserves_null_even_with_default_all_backends`
3. `http_decode_missing_field_uses_default_before_validation_all_backends`
4. `http_decode_unknown_field_rejected_all_backends`

Gate:
- `scripts/cargo_env.sh cargo test -p fusec --test config_runtime`
- `scripts/cargo_env.sh cargo test -p fusec --test golden_outputs`

### Slice `M1-PR4`: HTTP status + error JSON matrix parity (`FS-1.3`, `FS-1.6`)

Scope:
- extend `crates/fusec/tests/parity_ast_native.rs`
- optionally add focused matrix file `crates/fusec/tests/http_error_status_matrix.rs`

Tests to add:
1. `parity_http_error_status_bad_request_400`
2. `parity_http_error_status_unauthorized_401`
3. `parity_http_error_status_forbidden_403`
4. `parity_http_error_status_conflict_409`
5. `parity_http_error_status_std_error_override_respected`
6. `parity_http_error_status_unknown_error_maps_500_internal_error_json`

Gate:
- `scripts/cargo_env.sh cargo test -p fusec --test parity_ast_native`

### Slice `M1-PR5`: Dependency source-rule diagnostics matrix (`FS-3.1`, `FS-3.2`)

Scope:
- extend `crates/fuse/tests/project_cli.rs`

Tests to add:
1. `check_rejects_dependency_missing_source_required_code`
2. `check_rejects_dependency_git_and_path_conflict_code`
3. `check_rejects_dependency_refs_without_git_code`
4. `check_rejects_dependency_empty_path_code`
5. `check_rejects_dependency_empty_subdir_code`
6. `check_rejects_path_dependency_with_git_fields_code`
7. `check_reports_dependency_path_not_found_code`
8. `check_reports_dependency_git_subdir_not_found_code`
9. `check_accepts_semantically_identical_dependency_specs_without_false_conflict`

Gate:
- `scripts/cargo_env.sh cargo test -p fuse --test project_cli check_rejects_dependency_`
- `scripts/cargo_env.sh cargo test -p fuse --test project_cli check_reports_dependency_`

### Slice `M1-PR6`: Lockfile invariant + refresh-fingerprint matrix (`FS-3.3`, `FS-3.4`)

Scope:
- extend `crates/fuse/tests/project_cli.rs`

Tests to add:
1. `check_reports_lock_entry_missing_path_code`
2. `check_reports_lock_entry_missing_rev_code`
3. `check_reports_lock_entry_missing_git_code`
4. `check_reports_lock_entry_subdir_not_found_code`
5. `check_reports_lock_entry_unknown_source_code`
6. `check_reports_lock_parse_failure_code`
7. `build_lockfile_ignores_non_spec_manifest_edits`
8. `build_lockfile_refreshes_when_requested_spec_fingerprint_changes`

Gate:
- `scripts/cargo_env.sh cargo test -p fuse --test project_cli check_reports_lock_`
- `scripts/cargo_env.sh cargo test -p fuse --test project_cli build_lockfile_`

## Landing Order and Definition of Done

Recommended order:
1. `M1-PR1` -> `M1-PR2` (parser/static semantic surface first)
2. `M1-PR3` -> `M1-PR4` (runtime boundary and status/json parity)
3. `M1-PR5` -> `M1-PR6` (dependency + lockfile contract completion)

M1 can be marked complete when:
1. All six slices are merged.
2. `./scripts/semantic_suite.sh` passes.
3. `./scripts/authority_parity.sh` passes.
4. `governance/1.0.0_M0_BASELINE.md` statuses for `FS-1.1`, `FS-1.2`, `FS-1.3`, `FS-1.6`,
   `FS-1.7`, `FS-3.1`, `FS-3.2`, `FS-3.3`, `FS-3.4` are flipped from `In progress` to `Complete`.
