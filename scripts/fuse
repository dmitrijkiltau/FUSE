#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

usage() {
  cat <<'EOF'
usage: scripts/fuse <command> [args...]

commands:
  run      Run a Fuse package (fuse run)
  test     Run package tests (fuse test)
  build    Build the package (fuse build)
  check    Parse + sema check (fuse check)
  fmt      Format a Fuse file (fuse fmt)
  openapi  Emit OpenAPI JSON (fuse openapi)
  migrate  Run DB migrations (fuse migrate)
  lsp      Start the Fuse language server

examples:
  scripts/fuse run examples/cli_hello.fuse
  scripts/fuse test examples/project_demo.fuse
  scripts/fuse build
  scripts/fuse check examples/project_demo.fuse
  scripts/fuse fmt examples/project_demo.fuse
  scripts/fuse lsp
EOF
}

if [[ $# -lt 1 ]]; then
  usage
  exit 1
fi

cmd="$1"
shift

case "$cmd" in
  run|test|build|check|fmt|openapi|migrate)
    exec "$ROOT/scripts/cargo_env.sh" cargo run -p fuse -- "$cmd" "$@"
    ;;
  lsp)
    exec "$ROOT/scripts/cargo_env.sh" cargo run -p fusec --bin fuse-lsp -- "$@"
    ;;
  *)
    usage
    exit 1
    ;;
esac
