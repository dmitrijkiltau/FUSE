#!/usr/bin/env bash
set -euo pipefail

ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

usage() {
  cat <<'EOF'
usage: scripts/fuse <command> [args...]

commands:
  dev      Run package in watch mode (fuse dev)
  run      Run a Fuse package (fuse run)
  test     Run package tests (fuse test)
  build    Build the package (fuse build)
  check    Parse + sema check (fuse check)
  fmt      Format a Fuse file (fuse fmt)
  openapi  Emit OpenAPI JSON (fuse openapi)
  migrate  Run DB migrations (fuse migrate)
  lsp      Start the Fuse language server

examples:
  scripts/fuse run examples/cli_hello.fuse
  scripts/fuse dev examples/notes-api
  scripts/fuse test examples/project_demo.fuse
  scripts/fuse build
  scripts/fuse build --clean
  scripts/fuse check examples/project_demo.fuse
  scripts/fuse fmt examples/project_demo.fuse
  scripts/fuse lsp
EOF
}

if [[ $# -lt 1 ]]; then
  usage
  exit 1
fi

cmd="$1"
shift

if [[ "$cmd" =~ ^(dev|run|test|build|check|fmt|openapi|migrate)$ ]]; then
  has_manifest=0
  skip_next=0
  for arg in "$@"; do
    if [[ $skip_next -eq 1 ]]; then
      skip_next=0
      continue
    fi
    case "$arg" in
      --manifest-path)
        has_manifest=1
        skip_next=1
        ;;
      --file|--app|--backend|--clean)
        skip_next=1
        ;;
    esac
  done
  if [[ $has_manifest -eq 0 ]]; then
    pos_arg=""
    skip_next=0
    for arg in "$@"; do
      if [[ $skip_next -eq 1 ]]; then
        skip_next=0
        continue
      fi
      case "$arg" in
        --manifest-path|--file|--app|--backend|--clean)
          skip_next=1
          ;;
        --)
          break
          ;;
        --*)
          ;;
        *)
          pos_arg="$arg"
          break
          ;;
      esac
    done
    if [[ -n "$pos_arg" && -d "$pos_arg" && -f "$pos_arg/fuse.toml" ]]; then
      new_args=()
      removed=0
      skip_next=0
      for arg in "$@"; do
        if [[ $skip_next -eq 1 ]]; then
          new_args+=("$arg")
          skip_next=0
          continue
        fi
        case "$arg" in
          --manifest-path|--file|--app|--backend|--clean)
            new_args+=("$arg")
            skip_next=1
            ;;
          --)
            new_args+=("$arg")
            ;;
          *)
            if [[ $removed -eq 0 && "$arg" == "$pos_arg" ]]; then
              removed=1
              continue
            fi
            new_args+=("$arg")
            ;;
        esac
      done
      set -- --manifest-path "$pos_arg" "${new_args[@]}"
    fi
  fi
fi

case "$cmd" in
  dev|run|test|build|check|fmt|openapi|migrate)
    exec "$ROOT/scripts/cargo_env.sh" cargo run -p fuse -- "$cmd" "$@"
    ;;
  lsp)
    exec "$ROOT/scripts/cargo_env.sh" cargo run -p fusec --bin fuse-lsp -- "$@"
    ;;
  *)
    usage
    exit 1
    ;;
esac
