#!/usr/bin/env bash
set -euo pipefail

SELF_PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/$(basename "${BASH_SOURCE[0]}")"
SELF_REAL="$SELF_PATH"
if command -v readlink >/dev/null 2>&1; then
  resolved="$(readlink -f "$SELF_PATH" 2>/dev/null || true)"
  if [[ -n "$resolved" ]]; then
    SELF_REAL="$resolved"
  fi
fi

find_external_sass() {
  local old_ifs="$IFS"
  IFS=':'
  for dir in $PATH; do
    [[ -n "$dir" ]] || continue
    local candidate="$dir/sass"
    [[ -f "$candidate" && -x "$candidate" ]] || continue
    local candidate_real="$candidate"
    if command -v readlink >/dev/null 2>&1; then
      candidate_real="$(readlink -f "$candidate" 2>/dev/null || printf '%s' "$candidate")"
    fi
    if [[ "$candidate_real" != "$SELF_REAL" ]]; then
      IFS="$old_ifs"
      printf '%s\n' "$candidate"
      return 0
    fi
  done
  IFS="$old_ifs"
  return 1
}

resolve_import_path() {
  local base_dir="$1"
  local import_name="$2"
  local import_dir
  local import_file
  import_dir="$(dirname "$import_name")"
  import_file="$(basename "$import_name")"
  if [[ "$import_dir" == "." ]]; then
    import_dir=""
  fi

  local with_ext=0
  if [[ "$import_file" == *.scss || "$import_file" == *.sass ]]; then
    with_ext=1
  fi

  local candidates=()
  if [[ $with_ext -eq 1 ]]; then
    if [[ -n "$import_dir" ]]; then
      candidates+=("$base_dir/$import_dir/$import_file")
      candidates+=("$base_dir/$import_dir/_$import_file")
    else
      candidates+=("$base_dir/$import_file")
      candidates+=("$base_dir/_$import_file")
    fi
  else
    if [[ -n "$import_dir" ]]; then
      candidates+=("$base_dir/$import_dir/$import_file.scss")
      candidates+=("$base_dir/$import_dir/_$import_file.scss")
      candidates+=("$base_dir/$import_dir/$import_file.sass")
      candidates+=("$base_dir/$import_dir/_$import_file.sass")
    else
      candidates+=("$base_dir/$import_file.scss")
      candidates+=("$base_dir/_$import_file.scss")
      candidates+=("$base_dir/$import_file.sass")
      candidates+=("$base_dir/_$import_file.sass")
    fi
  fi

  local candidate
  for candidate in "${candidates[@]}"; do
    if [[ -f "$candidate" ]]; then
      printf '%s\n' "$candidate"
      return 0
    fi
  done
  return 1
}

declare -A SCSS_STACK=()

render_scss() {
  local file="$1"
  if [[ -n "${SCSS_STACK[$file]:-}" ]]; then
    return 0
  fi
  SCSS_STACK["$file"]=1

  local base_dir
  base_dir="$(dirname "$file")"
  local line
  local trimmed
  local import_re='^[[:space:]]*@import[[:space:]]+["'"'"']([^"'"'"']+)["'"'"'][[:space:]]*;?[[:space:]]*$'
  while IFS= read -r line || [[ -n "$line" ]]; do
    trimmed="${line#"${line%%[![:space:]]*}"}"
    if [[ "$line" =~ $import_re ]]; then
      local import_name="${BASH_REMATCH[1]}"
      local import_path
      if import_path="$(resolve_import_path "$base_dir" "$import_name")"; then
        render_scss "$import_path"
      else
        echo "error: cannot resolve SCSS import '$import_name' from '$file'" >&2
        exit 1
      fi
    elif [[ "$trimmed" =~ ^@(use|forward|mixin|include|extend|if|for|each|while|function)([[:space:]]|$) ]]; then
      echo "error: fallback compiler does not support '${BASH_REMATCH[1]}' in '$file'; install dart-sass" >&2
      exit 2
    elif [[ "$line" == *'$'* || "$line" == *'&'* ]]; then
      echo "error: fallback compiler does not support variables or nesting in '$file'; install dart-sass" >&2
      exit 2
    else
      printf '%s\n' "$line"
    fi
  done < "$file"

  unset 'SCSS_STACK[$file]'
}

compile_file() {
  local src="$1"
  local dst="$2"
  mkdir -p "$(dirname "$dst")"
  render_scss "$src" > "$dst"
}

compile_mapping() {
  local mapping=""
  local arg
  for arg in "$@"; do
    case "$arg" in
      --*) ;;
      *) mapping="$arg" ;;
    esac
  done

  if [[ -z "$mapping" || "$mapping" != *:* ]]; then
    echo "error: expected sass mapping argument 'source:destination'" >&2
    exit 2
  fi

  local src="${mapping%%:*}"
  local dst="${mapping#*:}"
  if [[ -d "$src" ]]; then
    mkdir -p "$dst"
    shopt -s nullglob
    local inputs=("$src"/*.scss "$src"/*.sass)
    local input
    for input in "${inputs[@]}"; do
      local base
      base="$(basename "$input")"
      if [[ "$base" == _* ]]; then
        continue
      fi
      base="${base%.*}"
      compile_file "$input" "$dst/$base.css"
    done
    shopt -u nullglob
    return 0
  fi

  if [[ ! -f "$src" ]]; then
    echo "error: SCSS source not found: $src" >&2
    exit 2
  fi
  compile_file "$src" "$dst"
}

if external_sass="$(find_external_sass)"; then
  exec "$external_sass" "$@"
fi

echo "warning: no external 'sass' found; using fallback compiler (supports @import expansion)." >&2
compile_mapping "$@"
